<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€å†¯Kçº¿è®­ç»ƒç³»ç»Ÿ - æ¯æ—¥20å›¾</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f1a 0%, #1a1a2e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨è¿›åº¦æ¡ */
        .progress-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .progress-title {
            font-size: 1.3em;
            color: #00d2ff;
        }

        .progress-date {
            color: #888;
        }

        .progress-bar-container {
            height: 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border-radius: 15px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
        }

        .progress-milestones {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            position: relative;
        }

        .milestone {
            width: 20%;
            text-align: center;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            font-size: 0.85em;
            color: #666;
        }

        .milestone.reached {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        /* åˆ†ç±»ç»Ÿè®¡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
            cursor: pointer;
            transition: all 0.3s;
        }

        .stat-card:hover {
            background: rgba(255,255,255,0.08);
            transform: translateY(-2px);
        }

        .stat-card.active {
            border-color: #00d2ff;
            background: rgba(0, 210, 255, 0.1);
        }

        .stat-number {
            font-size: 1.8em;
            font-weight: bold;
            color: #00d2ff;
        }

        .stat-label {
            color: #888;
            font-size: 0.85em;
            margin-top: 5px;
        }

        /* æ·»åŠ è¡¨å• */
        .add-form {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9em;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 0.95em;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00d2ff;
        }

        .submit-btn {
            width: 100%;
            padding: 14px;
            border: none;
            background: linear-gradient(135deg, #00d2ff, #3a7bd5);
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 210, 255, 0.3);
        }

        .submit-btn:disabled {
            background: #444;
            cursor: not-allowed;
            transform: none;
        }

        /* æ¡ˆä¾‹ç½‘æ ¼ */
        .cases-section {
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.4em;
            color: #fff;
        }

        .cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .case-card {
            background: rgba(255,255,255,0.03);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
            position: relative;
        }

        .case-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 210, 255, 0.2);
            border-color: rgba(0, 210, 255, 0.3);
        }

        .case-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            cursor: pointer;
        }

        .case-content {
            padding: 15px;
        }

        .case-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            margin-bottom: 8px;
            background: rgba(0, 210, 255, 0.2);
            color: #00d2ff;
        }

        .case-pattern {
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            margin-bottom: 5px;
        }

        .case-desc {
            color: #888;
            font-size: 0.85em;
            line-height: 1.4;
        }

        .case-date {
            color: #555;
            font-size: 0.75em;
            margin-top: 10px;
        }

        .case-delete-btn {
            position: absolute;
            bottom: 8px;
            left: 8px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: rgba(255, 71, 87, 0.15);
            color: #ff4757;
            border: none;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s;
        }

        .case-card:hover .case-delete-btn {
            opacity: 1;
        }

        .case-delete-btn:hover {
            background: rgba(255, 71, 87, 0.3);
            transform: scale(1.1);
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .modal-image {
            max-width: 100%;
            max-height: 80vh;
            border-radius: 10px;
        }

        .modal-close {
            position: absolute;
            top: -40px;
            right: 0;
            color: #fff;
            font-size: 2em;
            cursor: pointer;
        }

        .modal-info {
            text-align: center;
            margin-top: 20px;
            color: #e0e0e0;
            padding: 0 20px;
        }

        /* è¡¨å•æ¨¡æ€æ¡† */
        .form-modal-content {
            background: rgba(30,30,40,0.98);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #555;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        /* æˆåŠŸæç¤º */
        .success-toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #2ed573, #26af61);
            color: #fff;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(46, 213, 115, 0.4);
            transform: translateX(200%);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .success-toast.show {
            transform: translateX(0);
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        @media (max-width: 768px) {
            .cases-grid {
                grid-template-columns: 1fr;
            }
            .progress-milestones {
                flex-wrap: wrap;
            }
            .milestone {
                width: 48%;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¯æ—¥è¿›åº¦ -->
        <div class="progress-section">
            <div class="progress-header">
                <div>
                    <div class="progress-title">ğŸ“š ä»Šæ—¥å­¦ä¹ è¿›åº¦</div>
                    <div class="progress-date" id="currentDate"></div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 2em; font-weight: bold; color: #00d2ff;">
                        <span id="todayCount">0</span>/20
                    </div>
                    <div style="color: #666; font-size: 0.9em;">ä»Šæ—¥æ¡ˆä¾‹</div>
                </div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
            </div>
            <div class="progress-milestones">
                <div class="milestone" id="m5">5ä¸ª ğŸ¯</div>
                <div class="milestone" id="m10">10ä¸ª ğŸ’ª</div>
                <div class="milestone" id="m15">15ä¸ª ğŸ”¥</div>
                <div class="milestone" id="m20">20ä¸ª ğŸ†</div>
                <div class="milestone" id="m25">25+ â­</div>
            </div>
        </div>

        <!-- åˆ†ç±»ç»Ÿè®¡ -->
        <div class="stats-grid" id="statsGrid">
            <div class="loading">åŠ è½½ä¸­</div>
        </div>

        <!-- æ·»åŠ æ¡ˆä¾‹æŒ‰é’® -->
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 20px;">
            <button onclick="showAddModal()" class="submit-btn" style="max-width: 200px;">
                <span style="color: #fff;">â•</span> æ·»åŠ æ–°æ¡ˆä¾‹
            </button>
            <button onclick="exportData()" class="submit-btn" style="max-width: 120px; background: linear-gradient(135deg, #5a5a7e, #7a7a9e);">
                ğŸ’¾ å¤‡ä»½æ•°æ®
            </button>
            <button onclick="document.getElementById('importFile').click()" class="submit-btn" style="max-width: 120px; background: linear-gradient(135deg, #5a5a7e, #7a7a9e);">
                ğŸ“¥ æ¢å¤æ•°æ®
            </button>
            <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
        </div>

        <!-- æ¡ˆä¾‹å±•ç¤º -->
        <div class="cases-section">
            <div class="section-header">
                <h2 class="section-title" id="currentCategoryTitle">å…¨éƒ¨æ¡ˆä¾‹</h2>
                <span style="color: #888;" id="currentCategoryCount">å…± 0 ä¸ªæ¡ˆä¾‹</span>
            </div>
            <div class="cases-grid" id="casesGrid">
                <div class="loading">åŠ è½½ä¸­</div>
            </div>
        </div>
    </div>

    <!-- æ¡ˆä¾‹æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div class="modal" id="viewModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeViewModal()">&times;</span>
            <img class="modal-image" id="modalImage" src="" alt="">
            <div class="modal-info" id="modalInfo"></div>
        </div>
    </div>

    <!-- æ·»åŠ æ¡ˆä¾‹è¡¨å•æ¨¡æ€æ¡† -->
    <div class="modal" id="addModal">
        <div class="modal-content form-modal-content">
            <span class="modal-close" onclick="closeAddModal()">&times;</span>
            <h2 style="margin-bottom: 20px; color: #00d2ff;">ğŸ“¸ æ·»åŠ Kçº¿æ¡ˆä¾‹</h2>
            <form id="caseForm" onsubmit="submitCase(event)">
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #aaa;">ğŸ“Œ è‚¡ç¥¨ä»£ç /åç§°</label>
                    <input type="text" id="stockCode" placeholder="å¦‚ï¼š000001 å¹³å®‰é“¶è¡Œ" required>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #aaa;">ğŸ·ï¸ å½¢æ€åˆ†ç±»</label>
                    <select id="pattern" required>
                        <option value="">-- é€‰æ‹©å½¢æ€ --</option>
                        <option value="åŒåº•">ğŸ“ åŒåº•</option>
                        <option value="å·¦å³°çªç ´">â›°ï¸ å·¦å³°çªç ´</option>
                        <option value="é˜³é˜´é˜³">â˜€ï¸ é˜³é˜´é˜³</option>
                    </select>
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #aaa;">ğŸ–¼ï¸ Kçº¿æˆªå›¾</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="imageFile" accept="image/*" onchange="previewImage(this)" required style="display: none;">
                        <button type="button" onclick="document.getElementById('imageFile').click()" style="padding: 10px 20px; border: 1px dashed rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); color: #aaa; border-radius: 8px; cursor: pointer;">ğŸ“ é€‰æ‹©å›¾ç‰‡</button>
                        <span id="fileName" style="color: #888; font-size: 0.9em;">æœªé€‰æ‹©æ–‡ä»¶</span>
                    </div>
                    <img id="previewImg" style="max-width: 100%; max-height: 150px; border-radius: 8px; display: none; margin-top: 10px;">
                </div>
                <div class="form-group" style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 8px; color: #aaa;">ğŸ“ ç‰¹å¾æè¿°</label>
                    <textarea id="description" rows="3" placeholder="æè¿°è¿™ä¸ªKçº¿å½¢æ€çš„å…³é”®ç‰¹å¾..." required></textarea>
                </div>
                <button type="submit" class="submit-btn" id="submitBtn">âœ… æäº¤æ¡ˆä¾‹</button>
            </form>
        </div>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div class="success-toast" id="toast">âœ… æ¡ˆä¾‹æ·»åŠ æˆåŠŸï¼+1</div>

    <script>
        // Supabaseé…ç½®
        const SUPABASE_URL = 'https://tgrfvrnouclmelbpkfax.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_007dMTCLU1efYx97ocJqww_0nTMmPkH';

        // åˆå§‹åŒ–Supabaseå®¢æˆ·ç«¯
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // æ‰€æœ‰å½¢æ€åˆ†ç±»
        const ALL_PATTERNS = ['åŒåº•', 'å·¦å³°çªç ´', 'é˜³é˜´é˜³'];

        // æ¡ˆä¾‹æ•°æ®
        let casesData = [];
        let currentFilter = 'all';
        let uploadedImageFile = null;

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            updateDate();
            loadCases();
        });

        // æ›´æ–°æ—¥æœŸ
        function updateDate() {
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-CN', options);
        }

        // ä»SupabaseåŠ è½½æ¡ˆä¾‹
        async function loadCases() {
            try {
                const { data, error } = await supabase
                    .from('patterns')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                casesData = data || [];
                updateProgress();
                updateStats();
                renderCases();
            } catch (err) {
                console.error('åŠ è½½å¤±è´¥:', err);
                document.getElementById('casesGrid').innerHTML = `
                    <div class="empty-state">
                        <div>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•</div>
                    </div>
                `;
            }
        }

        // è·å–ä»Šå¤©çš„æ¡ˆä¾‹
        function getTodayCases() {
            const today = new Date().toDateString();
            return casesData.filter(c => {
                const caseDate = new Date(c.created_at);
                return caseDate.toDateString() === today;
            });
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const todayCases = getTodayCases();
            const count = todayCases.length;
            const percent = Math.min(Math.round((count / 20) * 100), 100);

            document.getElementById('todayCount').textContent = count;
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressBar').textContent = count >= 20 ? 'ğŸ‰ å®Œæˆ!' : percent + '%';

            // æ›´æ–°é‡Œç¨‹ç¢‘
            document.getElementById('m5').className = 'milestone' + (count >= 5 ? ' reached' : '');
            document.getElementById('m10').className = 'milestone' + (count >= 10 ? ' reached' : '');
            document.getElementById('m15').className = 'milestone' + (count >= 15 ? ' reached' : '');
            document.getElementById('m20').className = 'milestone' + (count >= 20 ? ' reached' : '');
            document.getElementById('m25').className = 'milestone' + (count >= 25 ? ' reached' : '');

            // å®Œæˆ20ä¸ªæ—¶çš„åº†ç¥æ•ˆæœ
            if (count === 20) {
                celebrate();
            }
        }

        // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
        function updateStats() {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            // å…¨éƒ¨
            statsGrid.innerHTML += `
                <div class="stat-card ${currentFilter === 'all' ? 'active' : ''}" onclick="filterByPattern('all')">
                    <div class="stat-number">${casesData.length}</div>
                    <div class="stat-label">ğŸ“Š å…¨éƒ¨</div>
                </div>
            `;

            // å„å½¢æ€ç»Ÿè®¡
            const patternCounts = {};
            casesData.forEach(c => {
                patternCounts[c.pattern] = (patternCounts[c.pattern] || 0) + 1;
            });

            ALL_PATTERNS.forEach(pattern => {
                const count = patternCounts[pattern] || 0;
                statsGrid.innerHTML += `
                    <div class="stat-card ${currentFilter === pattern ? 'active' : ''}" onclick="filterByPattern('${pattern}')">
                        <div class="stat-number">${count}</div>
                        <div class="stat-label">${pattern}</div>
                    </div>
                `;
            });
        }

        // æŒ‰å½¢æ€ç­›é€‰
        function filterByPattern(pattern) {
            currentFilter = pattern;
            document.getElementById('currentCategoryTitle').textContent =
                pattern === 'all' ? 'å…¨éƒ¨æ¡ˆä¾‹' : pattern + ' æ¡ˆä¾‹';
            updateStats();
            renderCases();
        }

        // æ¸²æŸ“æ¡ˆä¾‹
        function renderCases() {
            const grid = document.getElementById('casesGrid');
            const filtered = currentFilter === 'all' ?
                casesData :
                casesData.filter(c => c.pattern === currentFilter);

            document.getElementById('currentCategoryCount').textContent = `å…± ${filtered.length} ä¸ªæ¡ˆä¾‹`;

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“¸</div>
                        <div>${currentFilter === 'all' ? 'è¿˜æ²¡æœ‰æ¡ˆä¾‹ï¼Œå¼€å§‹æ·»åŠ å§ï¼' : 'è¯¥åˆ†ç±»æš‚æ— æ¡ˆä¾‹'}</div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: #444;">æ¯æ—¥ç›®æ ‡ï¼š20ä¸ªæ¡ˆä¾‹</div>
                    </div>
                `;
                return;
            }

            grid.innerHTML = '';
            const sorted = [...filtered].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            sorted.forEach(item => {
                const card = document.createElement('div');
                card.className = 'case-card';
                card.innerHTML = `
                    <img class="case-image" src="${item.image_url}" alt="${item.pattern}" data-id="${item.id}">
                    <div class="case-content">
                        <span class="case-tag">${item.pattern}</span>
                        <div class="case-pattern">${item.stock_code}</div>
                        <div class="case-desc">${item.description}</div>
                        <div class="case-date">${new Date(item.created_at).toLocaleString('zh-CN')}</div>
                    </div>
                    <button class="case-delete-btn" onclick="deleteCase(${item.id}, event)" title="åˆ é™¤æ¡ˆä¾‹">ğŸ—‘ï¸</button>
                `;
                card.querySelector('.case-image').addEventListener('click', () => openModal(item.id));
                grid.appendChild(card);
            });
        }

        // å›¾ç‰‡é¢„è§ˆ
        function previewImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                uploadedImageFile = file;
                document.getElementById('fileName').textContent = file.name;

                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('previewImg');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        // åˆ é™¤æ¡ˆä¾‹
        async function deleteCase(id, event) {
            event.stopPropagation();

            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¡ˆä¾‹å—ï¼Ÿ')) {
                return;
            }

            try {
                // è·å–æ¡ˆä¾‹ä¿¡æ¯ä»¥åˆ é™¤å›¾ç‰‡
                const caseToDelete = casesData.find(c => c.id === id);
                if (caseToDelete && caseToDelete.image_url) {
                    // ä»å›¾ç‰‡URLæå–æ–‡ä»¶å
                    const fileName = caseToDelete.image_url.split('/').pop();
                    await supabase.storage.from('kline-images').remove([fileName]);
                }

                // åˆ é™¤æ•°æ®åº“è®°å½•
                const { error } = await supabase.from('patterns').delete().eq('id', id);
                if (error) throw error;

                // é‡æ–°åŠ è½½
                await loadCases();
                showToast('ğŸ—‘ï¸ æ¡ˆä¾‹å·²åˆ é™¤');
            } catch (err) {
                console.error('åˆ é™¤å¤±è´¥:', err);
                alert('åˆ é™¤å¤±è´¥: ' + err.message);
            }
        }

        // æäº¤æ¡ˆä¾‹
        async function submitCase(event) {
            event.preventDefault();

            const stockCode = document.getElementById('stockCode').value.trim();
            const pattern = document.getElementById('pattern').value;
            const description = document.getElementById('description').value.trim();

            if (!uploadedImageFile) {
                alert('è¯·ä¸Šä¼ Kçº¿æˆªå›¾');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'â³ ä¸Šä¼ ä¸­...';

            try {
                // ç”Ÿæˆå”¯ä¸€æ–‡ä»¶å
                const fileExt = uploadedImageFile.name.split('.').pop();
                const fileName = `${Date.now()}.${fileExt}`;

                // ä¸Šä¼ å›¾ç‰‡åˆ°Storage
                const { error: uploadError } = await supabase.storage
                    .from('kline-images')
                    .upload(fileName, uploadedImageFile);

                if (uploadError) throw uploadError;

                // è·å–å…¬å¼€URL
                const { data: urlData } = supabase.storage
                    .from('kline-images')
                    .getPublicUrl(fileName);
                const imageUrl = urlData.publicUrl;

                // æ’å…¥æ•°æ®åº“è®°å½•
                const { error: insertError } = await supabase
                    .from('patterns')
                    .insert([{
                        stock_code: stockCode,
                        pattern: pattern,
                        description: description,
                        image_url: imageUrl
                    }]);

                if (insertError) throw insertError;

                // é‡æ–°åŠ è½½æ•°æ®
                await loadCases();

                // é‡ç½®è¡¨å•å¹¶å…³é—­æ¨¡æ€æ¡†
                closeAddModal();

                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showToast();

                // æ»šåŠ¨åˆ°æ¡ˆä¾‹åŒº
                document.querySelector('.cases-section').scrollIntoView({ behavior: 'smooth' });
            } catch (err) {
                console.error('æäº¤å¤±è´¥:', err);
                alert('æäº¤å¤±è´¥: ' + err.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… æäº¤æ¡ˆä¾‹';
            }
        }

        // æ˜¾ç¤ºæç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message || 'âœ… æ¡ˆä¾‹æ·»åŠ æˆåŠŸï¼+1';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // æŸ¥çœ‹æ¡ˆä¾‹æ¨¡æ€æ¡†
        function openModal(id) {
            const item = casesData.find(c => c.id === id);
            if (!item) return;

            document.getElementById('modalImage').src = item.image_url;
            document.getElementById('modalInfo').innerHTML = `
                <h3>${item.pattern} - ${item.stock_code}</h3>
                <p style="margin-top: 10px; color: #aaa;">${item.description}</p>
                <p style="margin-top: 10px; color: #666; font-size: 0.9em;">${new Date(item.created_at).toLocaleString('zh-CN')}</p>
            `;
            document.getElementById('viewModal').classList.add('active');
        }

        function closeViewModal() {
            document.getElementById('viewModal').classList.remove('active');
        }

        // æ·»åŠ æ¡ˆä¾‹æ¨¡æ€æ¡†
        function showAddModal() {
            document.getElementById('addModal').classList.add('active');
        }

        function closeAddModal() {
            document.getElementById('addModal').classList.remove('active');
            document.getElementById('caseForm').reset();
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('fileName').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            uploadedImageFile = null;
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('viewModal').addEventListener('click', function(e) {
            if (e.target === this) closeViewModal();
        });

        document.getElementById('addModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddModal();
        });

        // åº†ç¥æ•ˆæœ
        function celebrate() {
            alert('ğŸ‰ æ­å–œï¼å·²å®Œæˆä»Šæ—¥20ä¸ªæ¡ˆä¾‹ç›®æ ‡ï¼\nç»§ç»­ä¿æŒï¼Œæˆä¸ºKçº¿å¤§å¸ˆï¼');
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(casesData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `kline-cases-backup-${new Date().toISOString().slice(0,10)}.json`;
            link.click();
            URL.revokeObjectURL(url);
            showToast('âœ… æ•°æ®å·²å¯¼å‡º');
        }

        // å¯¼å…¥æ•°æ®
        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const text = await file.text();
                const importedData = JSON.parse(text);

                if (!Array.isArray(importedData)) {
                    throw new Error('æ•°æ®æ ¼å¼ä¸æ­£ç¡®');
                }

                if (!confirm(`å°†å¯¼å…¥ ${importedData.length} æ¡æ¡ˆä¾‹æ•°æ®ï¼Œç»§ç»­å—ï¼Ÿ`)) {
                    return;
                }

                let successCount = 0;
                for (const item of importedData) {
                    try {
                        // è·³è¿‡å·²å­˜åœ¨çš„è®°å½•
                        const { data: existing } = await supabase
                            .from('patterns')
                            .select('id')
                            .eq('image_url', item.image_url)
                            .single();

                        if (existing) continue;

                        await supabase.from('patterns').insert([{
                            stock_code: item.stock_code,
                            pattern: item.pattern,
                            description: item.description,
                            image_url: item.image_url
                        }]);
                        successCount++;
                    } catch (err) {
                        console.error('å¯¼å…¥å•æ¡å¤±è´¥:', item, err);
                    }
                }

                await loadCases();
                showToast(`âœ… æˆåŠŸå¯¼å…¥ ${successCount} æ¡æ•°æ®`);
            } catch (err) {
                console.error('å¯¼å…¥å¤±è´¥:', err);
                alert('å¯¼å…¥å¤±è´¥: ' + err.message);
            }

            // é‡ç½®input
            event.target.value = '';
        }
    </script>
</body>
</html>
